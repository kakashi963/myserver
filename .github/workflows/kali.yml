name: Kali

on:
  workflow_dispatch:

jobs:
  secure-access:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    container:
      image: kalilinux/kali-rolling
      options: --privileged

    steps:
      - name: Install All Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          echo "deb https://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" > /etc/apt/sources.list

          apt-get update -yqq
          apt-get install -y ca-certificates curl gnupg

          # Tailscale repo
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list

          apt-get update -yqq
          apt-get install -yqq tailscale openssh-server kali-desktop-xfce xrdp xorgxrdp dbus sudo procps net-tools kali-linux-default

          echo "âœ… Installed: Tailscale + SSH + RDP"

      - name: Connect Tailscale FIRST
        run: |
          tailscaled --state=/tmp/tailscaled.state --tun=userspace-networking --port=41641 &
          sleep 5

          tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-kali-${{ github.run_id }} \
            --accept-routes \
            --ssh

          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP (SSH enabled)"

      - name: Setup SSH Server
        run: |
          SSH_PASS=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)
          echo "root:$SSH_PASS" | chpasswd

          sed -i 's/#*PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sed -i 's/#*PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

          mkdir -p /var/run/sshd
          /usr/sbin/sshd -D -f /etc/ssh/sshd_config &
          sleep 3

          if ss -tlnp | grep -q :22; then
            echo "âœ… SSH ready on $TAILSCALE_IP:22"
            echo "SSH_PASSWORD=$SSH_PASS" >> $GITHUB_ENV
          fi

      - name: Setup RDP + User
        run: |
          # XFCE config
          cat > /root/.xsession << 'EOF'
          startxfce4
          EOF
          chmod +x /root/.xsession

          # xrdp config
          sed -i 's/use_vsock=true/use_vsock=false/' /etc/xrdp/xrdp.ini || true
          mkdir -p /var/run/xrdp; /usr/sbin/xrdp-sesman --nodaemon & sleep 2; /usr/sbin/xrdp --nodaemon &

          # RDP user
          RDP_PASS=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)
          useradd -m -s /bin/bash RDP; echo "RDP:$RDP_PASS" | chpasswd; usermod -aG sudo RDP
          cp /root/.xsession /home/RDP/; chmod +x /home/RDP/.xsession; chown RDP /home/RDP/.xsession

          echo "RDP_PASSWORD=$RDP_PASS" >> $GITHUB_ENV
          sleep 3; ss -tlnp | grep 3389 && echo "âœ… RDP ready"

      - name: Test Ports
        run: |
          TS_IP=$TAILSCALE_IP
          nc -zv $TS_IP 22 && echo "âœ… SSH confirmed"
          nc -zv $TS_IP 3389 && echo "âœ… RDP confirmed" || echo "RDP warming up..."

      - name: ACCESS INFO
        run: |
          cat << EOF
=======================================
ðŸŒ IP: $TAILSCALE_IP

ðŸ” SSH: ssh root@$TAILSCALE_IP
     Pass: $SSH_PASSWORD

ðŸ–¥ï¸ RDP: mstsc /v:$TAILSCALE_IP
     User: RDP | Pass: $RDP_PASSWORD

Cancel job to stop
=======================================
EOF

      - name: Keep Services Alive
        run: |
          while true; do
            pgrep sshd || { echo "Restart SSH"; /usr/sbin/sshd -D &; }
            pgrep xrdp || { echo "Restart RDP"; /usr/sbin/xrdp-sesman --nodaemon & sleep 1; /usr/sbin/xrdp --nodaemon &; }
            sleep 30
          done

