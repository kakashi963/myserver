name: Kali

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    container:
      image: kalilinux/kali-rolling
      options: --privileged

    steps:
      - name: Install Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive

          # Step 1: Use HTTP only (no SSL needed yet)
          echo "deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" > /etc/apt/sources.list

          # Retry apt update up to 3 times
          for i in 1 2 3; do
            apt-get update -y && break || sleep 10
          done

          # Step 2: Install SSL certs + curl first
          apt-get install -y --fix-missing ca-certificates curl gnupg wget

          # Step 3: Switch to HTTPS now that certs are available
          echo "deb https://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" > /etc/apt/sources.list

          for i in 1 2 3; do
            apt-get update -y && break || sleep 10
          done

          # Step 4: Install desktop + tools with retry and --fix-missing
          for i in 1 2 3; do
            apt-get install -y --fix-missing \
              kali-desktop-xfce \
              kali-themes kali-menu \
              xrdp xorgxrdp \
              dbus dbus-x11 \
              sudo procps net-tools iproute2 \
              kali-linux-default && break || sleep 15
          done

          echo "‚úÖ All dependencies installed"

      - name: Install and Enable SSH Server
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y openssh-server

          # Enable root login (generate secure password)
          SSH_PASS=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)
          echo "root:$SSH_PASS" | chpasswd

          # Config changes
          sed -i 's/#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sed -i 's/#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

          mkdir -p /var/run/sshd
          service ssh start || /usr/sbin/sshd -D &
          sleep 3

          # Verify
          if ss -tlnp | grep -q :22; then
            echo "‚úÖ SSH listening on port 22"
            echo "SSH_PASSWORD=$SSH_PASS" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è SSH failed to start"
            ps aux | grep sshd
            exit 1
          fi

      - name: Configure Core RDP Settings
        run: |
          # Generate machine-id (required even if dbus-daemon not started)
          dbus-uuidgen | tee /etc/machine-id /var/lib/dbus/machine-id || true

          # Allow root and any user to start X sessions
          echo "allowed_users=anybody" > /etc/X11/Xwrapper.config
          echo "needs_root_rights=yes" >> /etc/X11/Xwrapper.config

          # Set XFCE session for root
          cat > /root/.xsession << 'EOF'
          export XDG_SESSION_TYPE=x11
          export XDG_CONFIG_DIRS=/etc/xdg
          export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share/xfce4/panel/plugins:/usr/share
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4
          EOF
          chmod +x /root/.xsession

          # Fix xrdp config
          sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
          sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini || true
          sed -i 's/#.*xorg/xorg/' /etc/xrdp/xrdp.ini || true

          # Polkit fix ‚Äî allow any user to start sessions
          mkdir -p /etc/polkit-1/localauthority/50-local.d/
          cat > /etc/polkit-1/localauthority/50-local.d/allow-all.pkla << 'EOF'
          [Allow all users]
          Identity=unix-user:*
          Action=*
          ResultAny=yes
          ResultInactive=yes
          ResultActive=yes
          EOF

          # Create required dirs
          mkdir -p /var/run/xrdp /var/log/xrdp /var/run/dbus
          chmod 755 /var/run/xrdp

          # Start xrdp
          /usr/sbin/xrdp-sesman --nodaemon &
          sleep 2
          /usr/sbin/xrdp --nodaemon &
          sleep 3

          # Verify
          if ss -tlnp | grep -q 3389; then
            echo "‚úÖ xrdp listening on port 3389"
          else
            echo "‚ö†Ô∏è xrdp issue:"
            cat /var/log/xrdp/xrdp.log 2>/dev/null || true
            ps aux | grep xrdp
          fi

      - name: Create RDP User
        run: |
          RDP_PASS=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)
          userdel -r RDP 2>/dev/null || true
          useradd -m -s /bin/bash RDP
          echo "RDP:$RDP_PASS" | chpasswd
          usermod -aG sudo RDP

          cat > /home/RDP/.xsession << 'EOF'
          export XDG_SESSION_TYPE=x11
          export XDG_CONFIG_DIRS=/etc/xdg
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4
          EOF
          chmod +x /home/RDP/.xsession
          chown RDP:RDP /home/RDP/.xsession

          echo "RDP_PASSWORD=$RDP_PASS" >> $GITHUB_ENV
          echo "‚úÖ RDP user ready"

      - name: Establish Tailscale Connection
        run: |
          tailscaled --state=/tmp/tailscaled.state --tun=userspace-networking &
          sleep 5

          tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-kali-runner-$GITHUB_RUN_ID \
            --accept-routes \
            --ssh

          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "‚úÖ Tailscale ready: $TS_IP"

      - name: Verify Services
        run: |
          TS_IP=$TAILSCALE_IP
          echo "Testing services on $TS_IP..."

          # SSH test
          if timeout 5 nc -zv $TS_IP 22; then
            echo "‚úÖ SSH port 22 open"
          else
            echo "‚ö†Ô∏è SSH port 22 not reachable yet"
          fi

          # RDP test
          if timeout 5 nc -zv $TS_IP 3389; then
            echo "‚úÖ RDP port 3389 open"
          else
            echo "‚ö†Ô∏è RDP port 3389 not reachable yet"
          fi

      - name: Print Access Info
        run: |
          echo "==================================="
          echo "üéØ KALI ACCESS DETAILS"
          echo "==================================="
          echo "üåê Tailscale IP: $TAILSCALE_IP"
          echo ""
          echo "üîê SSH:"
          echo "  ssh root@$TAILSCALE_IP"
          echo "  Password: $SSH_PASSWORD"
          echo ""
          echo "üñ•Ô∏è RDP:"
          echo "  User: RDP"
          echo "  Pass: $RDP_PASSWORD"
          echo "  mstsc /v:$TAILSCALE_IP"
          echo ""
          echo "‚ö†Ô∏è Cancel workflow to stop session"
          echo "==================================="

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] Services check..."
            
            # Restart SSH if dead
            if ! ss -tlnp | grep -q :22; then
              echo "Restarting SSH..."
              service ssh restart || /usr/sbin/sshd -D &
            fi
            
            # Restart xrdp if dead
            if ! ss -tlnp | grep -q :3389; then
              echo "Restarting xrdp..."
              pkill xrdp || true
              sleep 1
              /usr/sbin/xrdp-sesman --nodaemon &
              sleep 2
              /usr/sbin/xrdp --nodaemon &
            fi
            
            sleep 60
          done
