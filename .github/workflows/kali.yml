name: Kali

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Build Kali Image with Systemd
        run: |
          cat > Dockerfile << 'EOF'
          FROM kalilinux/kali-rolling

          ENV DEBIAN_FRONTEND=noninteractive

          RUN echo "deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" \
                > /etc/apt/sources.list && \
              apt-get update -y && \
              apt-get install -y --fix-missing \
                systemd \
                systemd-sysv \
                ca-certificates curl gnupg wget && \
              apt-get clean && \
              rm -rf /lib/systemd/system/multi-user.target.wants/* \
                     /lib/systemd/system/local-fs.target.wants/* \
                     /lib/systemd/system/sockets.target.wants/*udev* \
                     /lib/systemd/system/sockets.target.wants/*initctl* \
                     /lib/systemd/system/sysinit.target.wants/systemd-tmpfiles-setup* \
                     /lib/systemd/system/systemd-update-utmp*

          VOLUME ["/sys/fs/cgroup"]
          CMD ["/usr/lib/systemd/systemd"]
          EOF

          docker build -t kali-systemd .
          echo "✅ Image built"

      - name: Start Kali Container with Systemd
        run: |
          docker run -d \
            --name kali \
            --privileged \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            --tmpfs /tmp \
            --tmpfs /run \
            --tmpfs /run/lock \
            kali-systemd

          echo "Waiting for systemd to initialize..."
          for i in $(seq 1 30); do
            if docker exec kali systemctl is-system-running 2>/dev/null | grep -qE "running|degraded"; then
              echo "✅ Systemd is ready"
              break
            fi
            echo "Attempt $i/30..."
            sleep 3
          done

      - name: Install Dependencies
        run: |
          docker exec kali bash -c '
            export DEBIAN_FRONTEND=noninteractive

            echo "deb https://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" \
              > /etc/apt/sources.list

            for i in 1 2 3; do
              apt-get update -y && break || sleep 10
            done

            for i in 1 2 3; do
              apt-get install -y --fix-missing \
                kali-desktop-xfce \
                kali-themes kali-menu \
                xrdp xorgxrdp \
                dbus dbus-x11 \
                sudo procps net-tools iproute2 \
                nodejs npm \
                screen \
                kali-linux-default && break || sleep 15
            done

            curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg \
              | tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null

            curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list \
              | tee /etc/apt/sources.list.d/tailscale.list

            for i in 1 2 3; do
              apt-get update -y && break || sleep 10
            done

            for i in 1 2 3; do
              apt-get install -y tailscale && break || sleep 10
            done

            echo "✅ All dependencies installed"
          '

      - name: Configure SSH Server
        run: |
          docker exec kali bash -c '
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -y openssh-server

            mkdir -p /var/run/sshd

            ROOT_PASS=$(cat /dev/urandom | tr -dc "A-Za-z0-9" | head -c 20)
            echo "root:$ROOT_PASS" | chpasswd
            echo "ROOT_SSH_PASS=$ROOT_PASS" >> /tmp/env_vars

            sed -i "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/" /etc/ssh/sshd_config
            sed -i "s/^PermitRootLogin.*/PermitRootLogin yes/" /etc/ssh/sshd_config

            systemctl enable ssh
            systemctl start ssh
            sleep 2

            if ss -tlnp | grep -q ":22"; then
              echo "✅ SSH listening on port 22"
            else
              echo "❌ SSH failed to start"
              exit 1
            fi
          '
          ROOT_SSH_PASS=$(docker exec kali bash -c 'grep ROOT_SSH_PASS /tmp/env_vars | cut -d= -f2')
          echo "ROOT_SSH_PASS=$ROOT_SSH_PASS" >> $GITHUB_ENV

      - name: Configure RDP Settings
        run: |
          docker exec kali bash -c '
            dbus-uuidgen | tee /etc/machine-id /var/lib/dbus/machine-id || true

            echo "allowed_users=anybody" > /etc/X11/Xwrapper.config
            echo "needs_root_rights=yes" >> /etc/X11/Xwrapper.config

            printf "export XDG_SESSION_TYPE=x11\nexport XDG_CONFIG_DIRS=/etc/xdg\nexport XDG_DATA_DIRS=/usr/share/xfce4:/usr/share/xfce4/panel/plugins:/usr/share\nunset DBUS_SESSION_BUS_ADDRESS\nstartxfce4\n" > /root/.xsession
            chmod +x /root/.xsession

            sed -i "s/use_vsock=true/use_vsock=false/g" /etc/xrdp/xrdp.ini || true

            mkdir -p /etc/polkit-1/localauthority/50-local.d/
            printf "[Allow all users]\nIdentity=unix-user:*\nAction=*\nResultAny=yes\nResultInactive=yes\nResultActive=yes\n" \
              > /etc/polkit-1/localauthority/50-local.d/allow-all.pkla

            mkdir -p /var/run/xrdp /var/log/xrdp
            chmod 755 /var/run/xrdp

            systemctl enable xrdp
            systemctl start xrdp
            sleep 3

            if ss -tlnp | grep -q 3389; then
              echo "✅ xrdp listening on port 3389"
            else
              echo "❌ xrdp failed:"
              cat /var/log/xrdp/xrdp.log 2>/dev/null || true
              exit 1
            fi
          '

      - name: Create RDP User
        run: |
          docker exec kali bash -c '
            PASSWORD=$(cat /dev/urandom | tr -dc "A-Za-z0-9" | head -c 16)

            userdel -r RDP 2>/dev/null || true
            useradd -m -s /bin/bash RDP
            echo "RDP:$PASSWORD" | chpasswd
            usermod -aG sudo RDP

            printf "export XDG_SESSION_TYPE=x11\nexport XDG_CONFIG_DIRS=/etc/xdg\nunset DBUS_SESSION_BUS_ADDRESS\nstartxfce4\n" > /home/RDP/.xsession
            chmod +x /home/RDP/.xsession
            chown RDP:RDP /home/RDP/.xsession

            echo "RDP_PASSWORD=$PASSWORD" >> /tmp/env_vars
            id RDP && echo "✅ RDP user created"
          '
          RDP_PASSWORD=$(docker exec kali bash -c 'grep RDP_PASSWORD /tmp/env_vars | cut -d= -f2')
          echo "RDP_PASSWORD=$RDP_PASSWORD" >> $GITHUB_ENV

      - name: Establish Tailscale Connection
        run: |
          docker exec -d kali tailscaled --state=/tmp/tailscaled.state --tun=userspace-networking
          sleep 5

          docker exec kali tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-$GITHUB_RUN_ID \
            --accept-routes \
            --ssh

          TS_IP=""
          RETRIES=0
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 20 ]; do
            TS_IP=$(docker exec kali tailscale ip -4 2>/dev/null || true)
            if [ -z "$TS_IP" ]; then
              echo "Waiting for Tailscale IP... ($RETRIES/20)"
              sleep 5
            fi
            RETRIES=$((RETRIES + 1))
          done

          if [ -z "$TS_IP" ]; then
            echo "❌ Tailscale IP not assigned"
            exit 1
          fi

          echo "✅ Tailscale IP: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify All Services
        run: |
          echo "--- Systemd Status ---"
          docker exec kali systemctl is-system-running || true

          echo "--- SSH ---"
          docker exec kali ss -tlnp | grep ':22' && echo "✅ SSH up" || echo "❌ SSH down"

          echo "--- xRDP ---"
          docker exec kali ss -tlnp | grep '3389' && echo "✅ xRDP up" || echo "❌ xRDP down"

          echo "--- Tailscale ---"
          docker exec kali tailscale status

      - name: Maintain Session
        run: |
          echo ""
          echo "======================================="
          echo "           KALI RDP ACCESS             "
          echo "======================================="
          echo "  Tailscale IP    : $TAILSCALE_IP"
          echo "  RDP Username    : RDP"
          echo "  RDP Password    : $RDP_PASSWORD"
          echo "  SSH Root Pass   : $ROOT_SSH_PASS"
          echo "======================================="
          echo "  Connect via     : mstsc / Remmina"
          echo "  Address         : $TAILSCALE_IP:3389"
          echo "======================================="
          echo ""

          while true; do
            echo "[$(date)] ✅ Active — $TAILSCALE_IP:3389"

            if ! docker exec kali ss -tlnp | grep -q 3389; then
              echo "⚠️ xrdp died, restarting..."
              docker exec kali systemctl restart xrdp || true
              sleep 3
            fi

            sleep 300
          done
