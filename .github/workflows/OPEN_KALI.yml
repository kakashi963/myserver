name: OPEN_KALI

on:
  workflow_dispatch:

jobs:
  kali-headless:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    container:
      image: kalilinux/kali-rolling
      options: --privileged

    steps:
      - name: Install Kali Tools (All, No GUI)
        run: |
          export DEBIAN_FRONTEND=noninteractive

          echo "deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" \
            > /etc/apt/sources.list

          for i in 1 2 3; do apt-get update -y && break || sleep 10; done
          apt-get install -y --fix-missing ca-certificates curl gnupg wget

          echo "deb https://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" \
            > /etc/apt/sources.list

          for i in 1 2 3; do apt-get update -y && break || sleep 10; done

          # Massive toolset: installs (almost) everything, no desktop by itself
          # You can swap for kali-linux-full or kali-linux-default if this is too big.
          for i in 1 2 3; do
            apt-get install -y --fix-missing \
              kali-linux-everything \
              sudo procps net-tools iproute2 dbus dbus-x11 && break || sleep 30
          done

          # Tailscale repo
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg \
            | tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null

          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list \
            | tee /etc/apt/sources.list.d/tailscale.list

          for i in 1 2 3; do apt-get update -y && break || sleep 10; done
          for i in 1 2 3; do apt-get install -y tailscale && break || sleep 10; done

          echo "✅ Kali tools (everything) + Tailscale installed"

      - name: Install and Enable SSH Server
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get install -y openssh-server

          ROOT_PASS=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 20)
          echo "root:$ROOT_PASS" | chpasswd
          echo "ROOT_SSH_PASS=$ROOT_PASS" >> $GITHUB_ENV

          sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

          mkdir -p /var/run/sshd
          /usr/sbin/sshd -D &
          sleep 2

          if ss -tlnp | grep -q ':22'; then
            echo "✅ SSH listening on port 22"
          else
            echo "❌ SSH failed to start"
            exit 1
          fi

      - name: Establish Tailscale Connection
        run: |
          tailscaled --state=/tmp/tailscaled.state --tun=userspace-networking &
          sleep 5

          tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=open-kali-$GITHUB_RUN_ID \
            --accept-routes \
            --accept-dns=false \
            --ssh

          TS_IP=""
          RETRIES=0
          while [ -z "$TS_IP" ] && [ $RETRIES -lt 20 ]; do
            TS_IP=$(tailscale ip -4 2>/dev/null || true)
            if [ -z "$TS_IP" ]; then
              echo "Waiting for Tailscale IP... ($RETRIES/20)"
              sleep 5
            fi
            RETRIES=$((RETRIES + 1))
          done

          if [ -z "$TS_IP" ]; then
            echo "❌ Tailscale IP not assigned after retries. Exiting."
            exit 1
          fi

          echo "✅ Tailscale IP: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

          if ss -tlnp | grep -q ':22'; then
            echo "✅ sshd listening on port 22 — connect via: ssh root@$TAILSCALE_IP"
          else
            echo "❌ sshd not running"
          fi

          echo ""
          tailscale status || true

      - name: Install OpenClaw (CLI only, no setup)
        run: |
          set -e
          export DEBIAN_FRONTEND=noninteractive

          # Just install OpenClaw. The installer will install Node 22+ if needed.
          # We do NOT run configure / gateway / Telegram / anything else here.
          curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard

          # Show version so you know it's installed; later you can run `openclaw configure`
          openclaw --version || openclaw help

      - name: Maintain Session
        run: |
          echo ""
          echo "======================================="
          echo "        KALI HEADLESS + OPENCLAW       "
          echo "======================================="
          echo "  Tailscale IP : $TAILSCALE_IP"
          echo "  SSH Root Pass: $ROOT_SSH_PASS"
          echo "======================================="
          echo "  SSH Connect  : ssh root@$TAILSCALE_IP"
          echo "======================================="
          echo ""
          echo "OpenClaw is installed. After SSH-ing in, you can run:"
          echo "  openclaw configure"
          echo "  openclaw config ..."
          echo "======================================="
          echo ""
          echo "Cancel this workflow run to terminate the session"
          echo ""

          while true; do
            echo "[$(date)] ✅ Session active — SSH on $TAILSCALE_IP"
            sleep 300
          done
